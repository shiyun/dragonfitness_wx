var init=function(){function t(t){if(_.isArray(t)){var o="";_.map(t,function(t,e){o+=0===e?'<option selected value="'+t.discountPrice+'" data-discount="'+t.discount+'" data-totalprice="'+t.totalPrice+'">'+t.months+"</option>":'<option value="'+t.discountPrice+'" data-discount="'+t.discount+'" data-totalprice="'+t.totalPrice+'">'+t.months+"</option>"}),u.html(o)}else c.promptLayer({tsinfo:"获取打折信息错误",btxt2:""})}function o(t){if(_.isArray(t)){var o="";_.map(t,function(t,e){var n="",i="";"1,2"==t.scope?(i="q1",n="通用优惠券"):"1"==t.scope?(i="q2",n="入会减免券"):(i="q3",n="会员减免券"),0===e?(o+='<option selected value="'+t.amount+'" data-code="'+t.code+'" data-scope="'+t.scope+'">'+t.name+"</option>",P=t.code):o+='<option value="'+t.amount+'" data-code="'+t.code+'" data-scope="'+t.scope+'">'+t.name+"</option>"}),d.html(o)}else c.promptLayer({tsinfo:"优惠券信息错误",btxt2:""})}function e(){var t=d.find("option:selected"),o=Number(m.html()),e=Number(g.html());if(y=0,t.length)var n=String(t.data("scope")),i=Number(t.val());else var n=null,i=0;if(console.log("memberPrice:"+e,"优惠券amount："+i,"月费moneyNum："+o,"最新价格nowPrice："+y,n),"1"==p&&(e=0),n)switch(n){case"1":v=a.add(o,e),i>e?e=0:e-=i,y=e+o;break;case"2":v=a.add(o,e),i>o?o=0:o-=i,y=e+o;break;case"1,2":v=a.add(o,e),y=i>o+e?0:o+e-i}else v=a.add(o,e),y=a.add(o,e);console.log("memberPrice:"+e,"优惠券amount："+i,"月费moneyNum："+o,"最新价格nowPrice："+y,n),f.text(y),h.text(Number(u.find("option:selected").data("totalprice"))+e)}function n(t){console.log(typeof t),console.log(t),wx.config({debug:!1,appId:t.appId,timestamp:t.timeStamp,nonceStr:t.nonceStr,signature:t.paySign,jsApiList:["chooseWXPay"]}),wx.ready(function(){wx.chooseWXPay({timestamp:t.timeStamp,nonceStr:t.nonceStr,"package":t["package"],signType:t.signType,paySign:t.paySign,success:function(t){c.promptLayer({tsinfo:"支付成功",btxt2:""}),i.post(i.api.UPDATEINFO,{token:r},function(t){},function(t){},{auth:!0})},fail:function(){c.promptLayer({tsinfo:"支付失败。",btxt2:""})}})})}if(!i)var i=new AJAX;if(!a)var a=new Util;if(!c)var c=new UI;var s=a.authPass();if(s){var r=$("#token").val(),p=$("#isMember").val(),u=$("#selectChoseMon"),d=$("#selectChoseMon2"),l=($(".basePrice"),$(".discountNum")),m=($(".monNum"),$(".moneyNum")),f=$(".nowPrice"),h=$(".oPrice"),y=0,v=0,b=1,P="",g=$(".memberPrice");"1"==p&&$(".delInfo").addClass("hidden"),i.post(i.api.PAY_ORDER_INIT,{token:r},function(n){"1000"==n.status.code?(g.html(n.result.memberInfo.discountPrice),memberPrice=n.result.memberInfo.discountPrice,l.html(n.result.serviceInfo[0].discount),m.html(n.result.serviceInfo[0].discountPrice),t(n.result.serviceInfo),o(n.result.coupons),e()):"1101"==n.status.code?location.href="/login":"1100"==n.status.code?i.post(i.api.LOGOUT,{},function(t){window.location.reload()},function(t){window.location.reload()}):c.promptLayer({tsinfo:"获取打折信息失败",btxt2:""})},function(t){c.promptLayer({tsinfo:"获取打折信息失败",btxt2:""})},{auth:!0}),u.on("change",function(){var t=$(this).find("option:selected"),o=t.data("discount"),n=t.val();b=t.text(),l.html(o),m.html(n),e()}),d.on("change",function(){var t=$(this).find("option:selected");P=t.data("code"),e()}),$(".submitOrder").on("click",function(){i.post(i.api.PAY_ORDER,{months:b,payType:"wxpay_js",couponNo:P,token:r,openId:r},function(t){console.log(t),"1000"==t.status.code?n(JSON.parse(t.result.payUrl)):c.promptLayer({tsinfo:"支付失败~",btxt2:""})},function(t){c.promptLayer({tsinfo:"支付失败！",btxt2:""})},{auth:!0})})}};$(function(){init&&init()});