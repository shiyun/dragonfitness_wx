var init=function(){function t(t){if(_.isArray(t)){var e="";_.map(t,function(t,n){e+=0===n?'<option selected value="'+t.discountPrice+'" data-discount="'+t.discount+'" data-totalprice="'+t.totalPrice+'">'+t.months+"</option>":'<option value="'+t.discountPrice+'" data-discount="'+t.discount+'" data-totalprice="'+t.totalPrice+'">'+t.months+"</option>"}),u.html(e)}else s.promptLayer({tsinfo:"获取打折信息错误",btxt2:""})}function e(t){if(_.isArray(t)){var e="";_.map(t,function(t,n){var o="",i="";"1,2"==t.scope?(i="q1",o="通用优惠券"):"1"==t.scope?(i="q2",o="入会减免券"):(i="q3",o="会员减免券"),0===n?(e+='<option selected value="'+t.amount+'" data-code="'+t.code+'" data-scope="'+t.scope+'">'+t.name+"</option>",x=t.code):e+='<option value="'+t.amount+'" data-code="'+t.code+'" data-scope="'+t.scope+'">'+t.name+"</option>"}),p.html(e)}else s.promptLayer({tsinfo:"优惠券信息错误",btxt2:""})}function n(){var t=p.find("option:selected"),e=t.data("scope"),n=t.val(),o=parseInt(m.html());switch(e){case"1":n>b?b=0:b-=n,h=b+o;break;case"2":n>o?o=0:o-=n,h=b+o;break;case"1,2":h=n>o+b?0:o+b-n}f.html(h),y=parseInt(o+b),v.html(y)}function o(t){WeixinJSBridge.invoke("getBrandWCPayRequest",t,function(t){WeixinJSBridge.log(t),WeixinJSBridge.log(t.err_msg),"get_brand_wcpay_request：ok"==t.err_msg})}function i(t){"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",function(){o(t)},!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",function(){o(t)}),document.attachEvent("onWeixinJSBridgeReady",function(){o(t)})):o(t)}if(!a)var a=new AJAX;if(!c)var c=new Util;if(!s)var s=new UI;var r=c.authPass();if(r){var d=$("#token").val(),u=$("#selectChoseMon"),p=$("#selectChoseMon2"),l=($(".basePrice"),$(".discountNum")),m=($(".monNum"),$(".moneyNum")),f=$(".nowPrice"),v=$(".oPrice"),h=0,y=0,g=1,x="",P=$(".memberPrice"),b=0;a.post(a.api.PAY_ORDER_INIT,{token:d},function(o){"1000"==o.status.code?(P.html(o.result.memberInfo.discountPrice),b=o.result.memberInfo.discountPrice,l.html(o.result.serviceInfo[0].discount),m.html(o.result.serviceInfo[0].discountPrice),t(o.result.serviceInfo),e(o.result.coupons),n()):s.promptLayer({tsinfo:"获取打折信息失败",btxt2:""})},function(t){s.promptLayer({tsinfo:"获取打折信息失败",btxt2:""})},{auth:!0}),u.on("change",function(){var t=$(this).find("option:selected"),e=t.data("discount"),o=t.val();g=t.text(),l.html(e),m.html(o),n()}),p.on("change",function(){var t=$(this).find("option:selected");x=t.data("code"),n()}),$(".submitOrder").on("click",function(){a.post(a.api.PAY_ORDER,{months:g,payType:"wxpay_js",couponNo:x,token:d,openId:d},function(t){console.log(t),"1000"==t.status.code?i(t.result.payUrl):s.promptLayer({tsinfo:"支付失败",btxt2:""})},function(t){s.promptLayer({tsinfo:"支付失败",btxt2:""})},{auth:!0})})}};$(function(){init&&init()});