var init=function(){function t(t){if(_.isArray(t)){var o="";_.map(t,function(t,e){o+=0===e?'<option selected value="'+t.discountPrice+'" data-discount="'+t.discount+'" data-totalprice="'+t.totalPrice+'">'+t.months+"</option>":'<option value="'+t.discountPrice+'" data-discount="'+t.discount+'" data-totalprice="'+t.totalPrice+'">'+t.months+"</option>"}),p.html(o)}else c.promptLayer({tsinfo:"获取打折信息错误",btxt2:""})}function o(t){if(_.isArray(t)){var o="";_.map(t,function(t,e){var n="",i="";"1,2"==t.scope?(i="q1",n="通用优惠券"):"1"==t.scope?(i="q2",n="入会减免券"):(i="q3",n="会员减免券"),0===e?(o+='<option selected value="'+t.amount+'" data-code="'+t.code+'" data-scope="'+t.scope+'">'+t.name+"</option>",b=t.code):o+='<option value="'+t.amount+'" data-code="'+t.code+'" data-scope="'+t.scope+'">'+t.name+"</option>"}),u.html(o)}else c.promptLayer({tsinfo:"优惠券信息错误",btxt2:""})}function e(){var t=u.find("option:selected"),o=t.data("scope"),e=t.val(),n=parseInt(d.html());switch(o){case"1":e>P?P=0:P-=e,h=P+n;break;case"2":e>n?n=0:n-=e,h=P+n;break;case"1,2":h=e>n+P?0:n+P-e}m.html(h),y=parseInt(n+P),f.html(y)}function n(t){console.log(typeof t),console.log(t),wx.config({debug:!1,appId:t.appId,timestamp:t.timeStamp,nonceStr:t.nonceStr,signature:t.paySign,jsApiList:["chooseWXPay"]}),wx.ready(function(){wx.chooseWXPay({timestamp:t.timeStamp,nonceStr:t.nonceStr,"package":t["package"],signType:t.signType,paySign:t.paySign,success:function(t){c.promptLayer({tsinfo:"支付成功",btxt2:""})},fail:function(){c.promptLayer({tsinfo:"支付失败。",btxt2:""})}})})}if(!i)var i=new AJAX;if(!a)var a=new Util;if(!c)var c=new UI;var s=a.authPass();if(s){var r=$("#token").val(),p=$("#selectChoseMon"),u=$("#selectChoseMon2"),l=($(".basePrice"),$(".discountNum")),d=($(".monNum"),$(".moneyNum")),m=$(".nowPrice"),f=$(".oPrice"),h=0,y=0,v=1,b="",g=$(".memberPrice"),P=0;i.post(i.api.PAY_ORDER_INIT,{token:r},function(n){"1000"==n.status.code?(g.html(n.result.memberInfo.discountPrice),P=n.result.memberInfo.discountPrice,l.html(n.result.serviceInfo[0].discount),d.html(n.result.serviceInfo[0].discountPrice),t(n.result.serviceInfo),o(n.result.coupons),e()):"1101"==n.status.code?location.href="/login":"1100"==n.status.code?i.post(i.api.LOGOUT,{},function(t){window.location.reload()},function(t){window.location.reload()}):c.promptLayer({tsinfo:"获取打折信息失败",btxt2:""})},function(t){c.promptLayer({tsinfo:"获取打折信息失败",btxt2:""})},{auth:!0}),p.on("change",function(){var t=$(this).find("option:selected"),o=t.data("discount"),n=t.val();v=t.text(),l.html(o),d.html(n),e()}),u.on("change",function(){var t=$(this).find("option:selected");b=t.data("code"),e()}),$(".submitOrder").on("click",function(){i.post(i.api.PAY_ORDER,{months:v,payType:"wxpay_js",couponNo:b,token:r,openId:r},function(t){console.log(t),"1000"==t.status.code?n(JSON.parse(t.result.payUrl)):c.promptLayer({tsinfo:"支付失败~",btxt2:""})},function(t){c.promptLayer({tsinfo:"支付失败！",btxt2:""})},{auth:!0})})}};$(function(){init&&init()});